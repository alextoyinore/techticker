
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check user role
    function isOneOfRoles(roles) {
      // Ensure the user is authenticated before checking roles
      if (request.auth == null) {
        return false;
      }
      // Access the user's role from their document in the /users collection
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in roles;
    }

    // ARTICLES
    match /articles/{articleId} {
      // Anyone can read a published article
      allow get: if resource.data.status == 'Published';
      // Anyone can list published articles
      allow list: if resource.data.status == 'Published';

      // Only specific roles can create, update, or delete articles
      allow create, update, delete: if isOneOfRoles(['admin', 'superadmin', 'editor', 'writer']);
    }

    // USERS
    match /users/{userId} {
      // Admins/Superadmins can list all user documents
      allow list: if isOneOfRoles(['admin', 'superadmin']);

      // A user can read/update their own data.
      // Admins/Superadmins can also read/update any user's data.
      allow get, update: if request.auth != null && (request.auth.uid == userId || isOneOfRoles(['admin', 'superadmin']));
      
      // Only Admins/Superadmins can delete a user document.
      allow delete: if isOneOfRoles(['admin', 'superadmin']);

      // Any authenticated user can create their own user document upon signup.
      allow create: if request.auth != null;
    }
    
    // COMMENTS
    match /comments/{commentId} {
      // Anyone can read and list approved comments
      allow get, list: if resource.data.status == 'Approved';
      
      // Admins can get and update any comment for moderation purposes
      allow get, list, update, delete: if isOneOfRoles(['admin', 'superadmin']);

      // Authenticated users can create comments (which will be 'Pending' by default)
      allow create: if request.auth != null;
    }
    
    // CATEGORIES
    match /categories/{categoryId} {
      // Any authenticated user can read categories (for the editor dropdown)
      allow get, list: if request.auth != null;
      
      // Only admins can manage categories
      allow create, update, delete: if isOneOfRoles(['admin', 'superadmin']);
    }

    // WIDGETS
    match /widgets/{widgetId} {
      // Any authenticated user can read widgets (for the layout builder)
      allow get, list: if request.auth != null;
      
      // Only admins can manage widgets
      allow create, update, delete: if isOneOfRoles(['admin', 'superadmin']);
    }

  }
}
