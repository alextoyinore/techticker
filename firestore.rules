rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users: Can read/update their own data. Admins can read anyone's data.
    // Everyone can create their own user doc on signup.
    match /users/{userId} {
      allow read, update: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
      // Admin/Superadmin access
      allow write, get: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin'];
    }

    // Articles:
    // Anyone can read published articles.
    // Admins, editors, writers can create/update articles.
    // Admins can delete any article.
    match /articles/{articleId} {
      allow read: if resource.data.status == 'Published' || (request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin', 'editor', 'writer']);
      allow create, update: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin', 'editor', 'writer'];
      allow delete: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin'];
    }

    // Comments:
    // Anyone can read approved comments.
    // Authenticated users can create pending comments.
    // Admins/editors can update comment status (approve/reject/etc).
    match /comments/{commentId} {
      allow read: if resource.data.status == 'Approved';
      allow create: if request.auth != null && request.resource.data.status == 'Pending';
      allow update: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin', 'editor'];
      allow delete: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin'];
    }
    
    // Categories:
    // Anyone can read categories.
    // Admins/editors can create/delete categories.
    match /categories/{categoryId} {
        allow read: if true;
        allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin', 'editor'];
    }
    
    // Widgets:
    // Anyone can read widgets.
    // Admins/editors can create/delete widgets.
    match /widgets/{widgetId} {
        allow read: if true;
        allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin', 'editor'];
    }
  }
}